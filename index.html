<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ„›ã•ã‚Œè–¬å±€ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</title>
    <meta name="description" content="èª¿å‰¤è–¬å±€ã®ãŸã‚ã®å“è³ªå‘ä¸Šãƒ»ææ¡ˆã‚¢ãƒ—ãƒª">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap');

        :root {
            --primary: #FF8BA7;
            --primary-dark: #E05D82;
            --bg: #FFF5F7;
            --card: #FFFFFF;
            --text: #4A4A4A;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding-bottom: 40px;
        }

        .card {
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(255, 139, 167, 0.1);
            transition: transform 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 10px rgba(224, 93, 130, 0.3);
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            margin: 0 auto;
        }
        
        .history-chart-container {
            position: relative;
            height: 150px;
            width: 100%;
            margin-top: 10px;
        }

        .check-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .check-item:hover {
            background-color: #FFF0F3;
        }
        .check-item input:checked + span {
            font-weight: bold;
            color: var(--primary-dark);
        }
        .check-item input:checked + span::after {
            content: ' âœ¨';
        }
        
        .score-badge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Type Selector */
        .type-selector label {
            cursor: pointer;
        }
        .type-selector input:checked + div {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Variation Tabs */
        .var-tab {
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        .var-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: bold;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: 20px;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: var(--card);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            color: var(--text);
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: #999;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(50, 50, 50, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 200;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        #toast.show {
            opacity: 1;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.5s ease forwards;
        }

        .hidden { display: none; }
        .header-title-area { cursor: pointer; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-gradient-to-r from-pink-400 to-pink-500 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="header-title-area" onclick="app.reset(false)">
                <h1 class="text-lg font-bold">æ„›ã•ã‚Œè–¬å±€ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</h1>
                <p class="text-xs opacity-90">æ‚£è€…æ§˜ã®å£°ã‹ã‚‰æ”¹å–„ã¸</p>
            </div>
            <div class="flex gap-2">
                <button onclick="app.toggleHelp(true)" class="text-xs bg-white/20 px-3 py-1 rounded-full hover:bg-white/30 flex items-center gap-1">
                    <span class="text-sm">â“</span>ä½¿ã„æ–¹
                </button>
                <button onclick="app.reset(true)" class="text-xs bg-white/20 px-3 py-1 rounded-full hover:bg-white/30">æœ€åˆã«æˆ»ã‚‹</button>
            </div>
        </div>
    </header>

    <div class="max-w-md mx-auto p-4">

        <!-- STEP 1: Hearing -->
        <div id="step1" class="animate-slide-up">
            
            <!-- Pharmacy Type Selector -->
            <div class="card p-4 mb-4">
                <h3 class="text-sm font-bold text-gray-500 mb-2">è–¬å±€ã®ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</h3>
                <div class="grid grid-cols-3 gap-2 type-selector">
                    <label>
                        <input type="radio" name="pType" value="local" checked class="hidden" onchange="app.changeType('local')">
                        <div class="border border-gray-200 rounded-lg p-2 text-center text-xs font-bold transition">
                            åœ°åŸŸå¯†ç€<br><span class="text-[10px] font-normal">ã‹ã‹ã‚Šã¤ã‘</span>
                        </div>
                    </label>
                    <label>
                        <input type="radio" name="pType" value="busy" class="hidden" onchange="app.changeType('busy')">
                        <div class="border border-gray-200 rounded-lg p-2 text-center text-xs font-bold transition">
                            é–€å‰ãƒ»ç·åˆ<br><span class="text-[10px] font-normal">ã‚¹ãƒ”ãƒ¼ãƒ‰</span>
                        </div>
                    </label>
                    <label>
                        <input type="radio" name="pType" value="home" class="hidden" onchange="app.changeType('home')">
                        <div class="border border-gray-200 rounded-lg p-2 text-center text-xs font-bold transition">
                            åœ¨å®…ãƒ¡ã‚¤ãƒ³<br><span class="text-[10px] font-normal">å®¶æ—é€£æº</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="card p-6 mb-6 text-center">
                <div class="flex justify-between items-start">
                    <div class="w-8"></div><!-- spacer -->
                    <div>
                        <div class="text-4xl mb-2">ğŸ©º</div>
                        <h2 class="text-xl font-bold mb-2 text-pink-600">ç¾çŠ¶ãƒ’ã‚¢ãƒªãƒ³ã‚°</h2>
                        <p class="text-sm text-gray-500">
                            ä»Šã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ã€‚<br>
                            <button onclick="app.shuffleQuestions()" class="text-xs text-blue-500 underline mt-1">
                                ğŸ”„ è³ªå•ã‚’å…¥ã‚Œæ›¿ãˆã‚‹
                            </button>
                        </p>
                    </div>
                    <div class="w-8"></div><!-- spacer -->
                </div>
                
                <!-- History Preview -->
                <div id="miniHistory" class="hidden text-xs text-gray-400 mt-3 bg-gray-50 p-2 rounded-lg">
                    å‰å›: <span id="lastDate">-</span> (ã‚¹ã‚³ã‚¢: <span id="lastScore">-</span>)
                </div>
            </div>

            <div id="questionsContainer">
                <!-- JS Populated -->
            </div>

            <button onclick="app.analyze()" class="btn-primary w-full py-4 rounded-full font-bold text-lg shadow-lg transform active:scale-95 transition">
                è¨ºæ–­ã™ã‚‹
            </button>
            
            <div class="mt-8 text-center">
                <button onclick="app.clearHistory()" class="text-xs text-gray-400 underline">å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
            </div>
        </div>


        <!-- STEP 2: Result -->
        <div id="step2" class="hidden animate-slide-up">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">è¨ºæ–­çµæœãƒ¬ãƒãƒ¼ãƒˆ</h2>
                <div class="score-badge">
                    <span class="text-xs opacity-80">ã‚¹ã‚³ã‚¢</span>
                    <span class="text-2xl" id="totalScore">0</span>
                </div>
            </div>

            <div class="card p-4 mb-6">
                <!-- Radar Chart -->
                <div class="chart-container mb-4">
                    <canvas id="radarChart"></canvas>
                </div>
                
                <p id="analysisComment" class="text-center font-bold text-pink-600 text-sm mb-4"></p>

                <!-- Copy Report Button -->
                <div class="text-center mb-4">
                    <button onclick="app.copyReport()" class="bg-gray-100 text-gray-600 text-xs px-4 py-2 rounded-full border border-gray-300 hover:bg-gray-200">
                        ğŸ“‹ è¨ºæ–­çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜
                    </button>
                </div>

                <!-- History Chart -->
                <div class="border-t border-gray-100 pt-4">
                    <h4 class="text-xs font-bold text-gray-500 mb-2">ğŸ“ˆ æˆé•·ã®è¨˜éŒ²ï¼ˆéå»5å›ï¼‰</h4>
                    <div class="history-chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Proposals -->
            <h3 class="font-bold text-gray-700 mb-4">ğŸ’¡ ã‚¿ã‚¤ãƒ—åˆ¥ï¼šæ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <div id="proposalList" class="space-y-4"></div>

            <div class="mt-8 text-center">
                <p class="text-xs text-gray-500 mb-2">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ãŸã‚‰...</p>
                <button onclick="app.showSnsDraft()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white w-full py-3 rounded-full font-bold shadow-lg">
                    SNSæŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹
                </button>
            </div>
        </div>


        <!-- STEP 3: SNS Draft -->
        <div id="step3" class="hidden animate-slide-up">
            <div class="flex items-center mb-4 cursor-pointer" onclick="app.backToResult()">
                <span class="text-gray-400 mr-2">â†</span>
                <h2 class="text-xl font-bold text-gray-800">SNSæŠ•ç¨¿ãƒ‰ãƒ©ãƒ•ãƒˆ</h2>
            </div>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r">
                <p class="text-sm text-blue-800 font-bold mb-1">ç´ æ™´ã‚‰ã—ã„å–ã‚Šçµ„ã¿ã§ã™ï¼</p>
                <p class="text-xs text-blue-600">ã“ã®æ”¹å–„ã‚’SNSã§ç™ºä¿¡ã—ã€æ‚£è€…æ§˜ã¨ã®ä¿¡é ¼é–¢ä¿‚ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ã€‚</p>
            </div>

            <div class="card p-6 mb-6">
                <div class="flex justify-center gap-2 mb-3">
                    <button class="var-tab active" onclick="app.setDraftVariation(0)">æ¡ˆâ‘  æ¨™æº–</button>
                    <button class="var-tab" onclick="app.setDraftVariation(1)">æ¡ˆâ‘¡ è¦ªã—ã¿</button>
                    <button class="var-tab" onclick="app.setDraftVariation(2)">æ¡ˆâ‘¢ ã‚·ãƒ³ãƒ—ãƒ«</button>
                </div>

                <!-- Input area with auto height -->
                <div id="snsDraftText" class="w-full min-h-[12rem] h-auto p-4 bg-gray-50 rounded-xl border border-gray-200 text-sm leading-relaxed mb-6 outline-none focus:border-blue-400 whitespace-pre-wrap" contenteditable="true">
                    <!-- JS Generated Text -->
                </div>

                <div>
                    <button onclick="app.copyText()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold text-sm hover:bg-gray-700 transition shadow-lg">
                        ã‚³ãƒ”ãƒ¼ã™ã‚‹
                    </button>
                </div>
            </div>

            <!-- External Link Area -->
            <div class="card p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-none shadow-none text-center">
                <p class="text-sm font-bold text-indigo-800 mb-2">ã‚‚ã£ã¨æœ¬æ ¼çš„ã«ä½œã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ</p>
                <p class="text-xs text-gray-600 mb-4">
                    å­£ç¯€ã®æŒ¨æ‹¶ã€NGãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã€<br>
                    å†™çœŸã«åˆã‚ã›ãŸæŠ•ç¨¿ä½œæˆãªã‚‰ã“ã¡ã‚‰
                </p>
                <a href="https://spc-jp.github.io/pharmacy-sns-navigator/" target="_blank" class="block w-full bg-indigo-500 text-white font-bold py-3 rounded-full shadow-lg hover:bg-indigo-600 transition transform hover:-translate-y-1">
                    ã‚„ã•ã—ã„è–¬å±€SNSãƒŠãƒ“ã¸ç§»å‹• ğŸš€
                </a>
            </div>
            
            <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                <a href="https://web.gogo.jp/cp17080360376191/form/contact" target="_blank" class="text-xs text-blue-400 hover:text-blue-600 underline">
                    ãŠå•ã„åˆã‚ã›ï¼šOZ Contactã¸
                </a>
            </div>
        </div>

    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay" onclick="app.toggleHelp(false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="app.toggleHelp(false)">&times;</button>
            <h3 class="text-lg font-bold text-pink-600 mb-4 text-center">ã“ã®ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹</h3>
            
            <div class="space-y-4">
                <div>
                    <h4 class="font-bold text-gray-700 mb-1">ğŸ¯ ã‚¢ãƒ—ãƒªã®ç›®çš„</h4>
                    <p class="text-sm text-gray-500 leading-relaxed">
                        æ‚£è€…æ§˜ãŠä¸€äººãŠã²ã¨ã‚Šã‚’å¤§åˆ‡ã«ã™ã‚‹ã€Œæ„›ã•ã‚Œã‚‹è–¬å±€ã€ã¸ã€‚<br>
                        æ—¥ã€…ã®å°ã•ãªæ°—é…ã‚Šã‚„æ”¹å–„ã‚’ææ¡ˆã—ã€ãã®æ¸©ã‹ã„å–ã‚Šçµ„ã¿ã‚’SNSã§ç™ºä¿¡ã™ã‚‹ã“ã¨ã§ã€åœ°åŸŸã¨ã®ä¿¡é ¼ã‚’æ·±ã‚ã¾ã™ã€‚
                    </p>
                </div>
                
                <div class="bg-pink-50 p-4 rounded-xl border border-pink-100">
                    <h4 class="font-bold text-gray-700 mb-2">ğŸš€ ä½¿ã„æ–¹ã®æµã‚Œ</h4>
                    <ol class="text-sm text-gray-600 list-none space-y-3">
                        <li class="flex items-start">
                            <span class="bg-pink-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mr-2 flex-shrink-0 mt-0.5">1</span>
                            <div>
                                <strong class="text-pink-600 block mb-0.5">ç¾çŠ¶ãƒã‚§ãƒƒã‚¯</strong>
                                è–¬å±€ã‚¿ã‚¤ãƒ—ã‚’é¸ã³ã€ä»Šæ—¥ã®çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚<br>
                                <span class="text-xs text-blue-500 font-bold">â€»ã€ŒğŸ”„ è³ªå•ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã€ã§ãƒãƒ³ãƒãƒªé˜²æ­¢ï¼</span>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <span class="bg-pink-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mr-2 flex-shrink-0 mt-0.5">2</span>
                            <div>
                                <strong class="text-pink-600 block mb-0.5">è¨ºæ–­ï¼†ã‚¢ãƒ‰ãƒã‚¤ã‚¹</strong>
                                ã‚¹ã‚³ã‚¢ã‚’è¦‹ã¦ã€ä»Šã™ãã§ãã‚‹æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸ã³ã¾ã™ã€‚
                            </div>
                        </li>
                        <li class="flex items-start">
                            <span class="bg-pink-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mr-2 flex-shrink-0 mt-0.5">3</span>
                            <div>
                                <strong class="text-pink-600 block mb-0.5">SNSæŠ•ç¨¿ä½œæˆ</strong>
                                3ã¤ã®æ–‡æ¡ˆã‹ã‚‰é¸ã‚“ã§SNSã«æŠ•ç¨¿ã—ã¾ã—ã‚‡ã†ã€‚<br>
                                <span class="text-xs text-indigo-500 mt-1 block">â€»è©³ç´°ãªä½œæˆãƒ„ãƒ¼ãƒ«ã¸ã®ç§»å‹•ã‚‚å¯èƒ½ã§ã™</span>
                            </div>
                        </li>
                    </ol>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button class="btn-primary px-8 py-2 rounded-full text-sm font-bold shadow-md" onclick="app.toggleHelp(false)">ã¨ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Reset Confirm Modal (Custom) -->
    <div id="resetModal" class="modal-overlay" onclick="app.toggleResetModal(false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">æœ€åˆã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ</h3>
            <p class="text-sm text-gray-600 text-center mb-6">
                å…¥åŠ›ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚<br>
                ï¼ˆè¨ºæ–­å±¥æ­´ã¯ä¿å­˜ã•ã‚Œã¾ã™ï¼‰
            </p>
            <div class="flex gap-4 justify-center">
                <button class="bg-gray-100 text-gray-600 px-6 py-2 rounded-full font-bold text-sm" onclick="app.toggleResetModal(false)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="bg-pink-500 text-white px-6 py-2 rounded-full font-bold text-sm shadow-md" onclick="app.executeReset()">OK</button>
            </div>
        </div>
    </div>

    <!-- History Clear Confirm Modal (Added) -->
    <div id="historyClearModal" class="modal-overlay" onclick="app.toggleHistoryModal(false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
            <p class="text-sm text-gray-600 text-center mb-6">
                éå»ã®è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ãŒã™ã¹ã¦æ¶ˆå»ã•ã‚Œã¾ã™ã€‚<br>
                ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
            </p>
            <div class="flex gap-4 justify-center">
                <button class="bg-gray-100 text-gray-600 px-6 py-2 rounded-full font-bold text-sm" onclick="app.toggleHistoryModal(false)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="bg-red-500 text-white px-6 py-2 rounded-full font-bold text-sm shadow-md" onclick="app.executeClearHistory()">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

    <script>
        // Question Pool
        const questionPool = {
            env: [
                "å¾…åˆå®¤ã®è¦³è‘‰æ¤ç‰©ã‚„æ²ç¤ºç‰©ã¯å­£ç¯€æ„ŸãŒã‚ã‚‹",
                "å…¥ã‚Šå£ã‚„ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã«ã‚´ãƒŸã‚„æ±šã‚ŒãŒãªã„",
                "BGMã‚„ç…§æ˜ã¯æ‚£è€…æ§˜ãŒè½ã¡ç€ã‘ã‚‹è¨­å®šã ",
                "ãƒˆã‚¤ãƒ¬ã‚„æ´—é¢å°ã®ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã¯å……å®Ÿã—ã¦ã„ã‚‹",
                "ã‚­ãƒƒã‚ºã‚¹ãƒšãƒ¼ã‚¹ã‚„çµµæœ¬ã¯æ•´ç†æ•´é “ã•ã‚Œã¦ã„ã‚‹",
                "æ²ç¤ºç‰©ã¯è‰²ã‚ã›ã¦ãŠã‚‰ãšã€æœ€æ–°ã®æƒ…å ±ã "
            ],
            hosp: [
                "æ‚£è€…æ§˜ãŒå…¥åº—ã—ãŸéš›ã€å¿…ãšç›®ã‚’è¦‹ã¦æŒ¨æ‹¶ã—ã¦ã„ã‚‹",
                "ãŠè–¬æ‰‹å¸³ã®æœ‰ç„¡ã ã‘ã§ãªãã€ä½“èª¿ã®å¤‰åŒ–ã‚‚èã„ã¦ã„ã‚‹",
                "é«˜é½¢ã®æ–¹ã‚„å­ä¾›é€£ã‚Œã®æ–¹ã¸ã€åº§å¸­ã¾ã§ã®é…æ…®ãŒã‚ã‚‹",
                "å°‚é–€ç”¨èªã‚’ä½¿ã‚ãšã€ã‚ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã§èª¬æ˜ã—ã¦ã„ã‚‹",
                "å¾…ã¡æ™‚é–“ãŒé•·ã„æ™‚ã€é€”ä¸­ã§ãŠå£°ãŒã‘ã‚’ã—ã¦ã„ã‚‹",
                "æœè–¬æŒ‡å°ã®éš›ã€æ‚£è€…æ§˜ã®ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’ç¢ºèªã—ã¦ã„ã‚‹"
            ],
            info: [
                "SNSã‚„æ²ç¤ºæ¿ã§ã€æ··é›‘çŠ¶æ³ã‚„ä¼‘æ—¥æƒ…å ±ã‚’ä¼ãˆã¦ã„ã‚‹",
                "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹æ±ºæ¸ˆã«å¯¾å¿œã—ã¦ã„ã‚‹",
                "Googleãƒãƒƒãƒ—ã®å£ã‚³ãƒŸã«è¿”ä¿¡ã—ã¦ã„ã‚‹",
                "LINEç­‰ã§å‡¦æ–¹ç®‹é€ä¿¡ã®ä»•çµ„ã¿ã‚’æ¡ˆå†…ã—ã¦ã„ã‚‹",
                "å¥åº·ã‚¤ãƒ™ãƒ³ãƒˆã‚„ç›¸è«‡ä¼šã®å‘ŠçŸ¥ã‚’è¡Œã£ã¦ã„ã‚‹",
                "åœ¨å®…å¯¾å¿œã‚„åœ°åŸŸé€£æºã«ã¤ã„ã¦åº—é ­ã§ç™ºä¿¡ã—ã¦ã„ã‚‹"
            ]
        };

        const app = {
            chart: null,
            historyChart: null,
            currentType: 'local',
            data: { env: 0, hosp: 0, info: 0 },
            currentProposal: null,
            historyData: [],
            activeQuestions: { env: [], hosp: [], info: [] },
            
            currentDraftVariations: [],

            adviceDatabase: {
                // åœ°åŸŸå¯†ç€ï¼ˆlocalï¼‰
                local: {
                    env: [
                        { title: "å­£ç¯€ã®é£¾ã‚Šä»˜ã‘", desc: "å­£ç¯€æ„Ÿã¯ã€Œå¤‰åŒ–ã¸ã®æ°—é…ã‚Šã€ã®è¨¼ã€‚å°ã•ãªèŠ±ä¸€è¼ªã§ã‚‚å®‰å¿ƒæ„Ÿã«ã¤ãªãŒã‚Šã¾ã™ã€‚", snsTemplate: "ã€ä»Šæœˆã®å¾…åˆå®¤ğŸŒ¸ã€‘\nã“ã‚“ã«ã¡ã¯ï¼\nå¾…åˆå®¤ã«ãŠèŠ±ã‚’é£¾ã‚Šã¾ã—ãŸã€‚\nãŠè–¬ã‚’ãŠå¾…ã¡ã®é–“ã€å°‘ã—ã§ã‚‚ãƒ›ãƒƒã¨ã—ã¦ã„ãŸã ã‘ã‚Œã°å¬‰ã—ã„ã§ã™ã€‚\n#ç™’ã‚„ã— #åœ°åŸŸå¯†ç€" },
                        { title: "æ‰‹æ›¸ãPOPã®å°å…¥", desc: "æ¸©ã‹ã¿ã®ã‚ã‚‹æ‰‹æ›¸ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã€ãŠã™ã™ã‚å•†å“ã‚„å¥åº·æƒ…å ±ã‚’ä¼ãˆã¾ã—ã‚‡ã†ã€‚", snsTemplate: "ã€ã‚¹ã‚¿ãƒƒãƒ•ã®ãŠã™ã™ã‚âœï¸ã€‘\nä¹¾ç‡¥ã™ã‚‹å­£ç¯€ã«å‘ã‘ã¦ã€æ‰‹æ›¸ãPOPã‚’ä½œã‚Šã¾ã—ãŸï¼\nä¿æ¹¿ã‚±ã‚¢ã®ã‚³ãƒ„ã€ãœã²ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã­ã€‚\n#æ‰‹æ›¸ãPOP #å¥åº·ç›¸è«‡" }
                    ],
                    hosp: [
                        { title: "ã€Œãƒ—ãƒ©ã‚¹ä¸€è¨€ã€é‹å‹•", desc: "å¤©æ°—ã‚„ä½“èª¿ã‚’æ°—é£ã†ä¸€è¨€ã‚’æ·»ãˆã€å¿ƒç†çš„ãªè·é›¢ã‚’ç¸®ã‚ã¾ã—ã‚‡ã†ã€‚", snsTemplate: "ã€å¿ƒã‚‚æ¸©ã‹ãâ˜€ï¸ã€‘\nä»Šæ—¥ã¯å¯’ã„ã§ã™ã­ã€‚\nå½“è–¬å±€ã§ã¯ã€æ¸©ã‹ã„ãŠèŒ¶ã‚’ã”ç”¨æ„ã—ã¦ãŠã‚Šã¾ã™ã€‚\nãŠè–¬ã®ã“ã¨ä»¥å¤–ã§ã‚‚ã€ãŠæ°—è»½ã«ãŠå£°ãŒã‘ãã ã•ã„ã€‚\n#å¥åº·ã‚µãƒãƒ¼ãƒˆ #ãƒ›ãƒƒã¨ä¸€æ¯" },
                        { title: "åå‰å‘¼ã³ã‹ã‘", desc: "å¯èƒ½ã§ã‚ã‚Œã°ã€Œã€‡ã€‡ã•ã‚“ã€ã¨åå‰ã‚’å‘¼ã‚“ã§å¯¾å¿œã—ã€è¦ªè¿‘æ„Ÿã‚’é«˜ã‚ã¾ã—ã‚‡ã†ã€‚", snsTemplate: "ã€ã‹ã‹ã‚Šã¤ã‘è–¬å±€ã¨ã—ã¦ğŸ¤ã€‘\nç§ãŸã¡ã¯ã€æ‚£è€…æ§˜ãŠä¸€äººãŠä¸€äººã®é¡”ãŒè¦‹ãˆã‚‹é–¢ä¿‚ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚\nã€Œã„ã¤ã‚‚ã®ï¼ã€ã§é€šã˜ã‚‹å®‰å¿ƒæ„Ÿã‚’ã€‚\n#ã‹ã‹ã‚Šã¤ã‘ #ç›¸è«‡" }
                    ],
                    info: [
                        { title: "æ··é›‘çŠ¶æ³ç™ºä¿¡", desc: "ç©ºã„ã¦ã„ã‚‹æ™‚é–“ã‚’æ¡ˆå†…ã—ã€åˆ©ä¾¿æ€§ã‚’é«˜ã‚ã¾ã—ã‚‡ã†ã€‚", snsTemplate: "ã€ã‚¹ãƒ ãƒ¼ã‚ºãªå—å–ã®ãŸã‚ã«ğŸ•°ï¸ã€‘\nå¹³æ—¥ã®14ã€œ16æ™‚ã¯æ¯”è¼ƒçš„ã‚†ã£ãŸã‚Šã—ã¦ã„ã¾ã™ã€‚\nãŠè²·ã„ç‰©ã¤ã„ã§ã«ãœã²ãŠç«‹ã¡å¯„ã‚Šãã ã•ã„ï¼\n#æ™‚çŸ­ #å¾…ã¡æ™‚é–“ãªã—" }
                    ]
                },
                // é–€å‰ãƒ»ç·åˆï¼ˆbusyï¼‰
                busy: {
                    env: [
                        { title: "å‹•ç·šã®ç¢ºä¿ã¨æ•´ç†", desc: "ã‚¹ãƒ ãƒ¼ã‚ºãªç§»å‹•ãŒã§ãã‚‹ã‚ˆã†ã€ä¸è¦ãªç‰©ã‚’ç½®ã‹ãšã‚¹ãƒƒã‚­ãƒªã•ã›ã¾ã—ã‚‡ã†ã€‚", snsTemplate: "ã€å¿«é©ãªç©ºé–“ã¸âœ¨ã€‘\nå¾…åˆå®¤ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å°‘ã—å¤‰æ›´ã—ã¾ã—ãŸã€‚\nãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼ã‚„è»Šæ¤…å­ã®æ–¹ã‚‚é€šã‚Šã‚„ã™ããªã£ã¦ã„ã¾ã™ã€‚\n#ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼ #å¿«é©ç©ºé–“" }
                    ],
                    hosp: [
                        { title: "æ­£ç¢ºã§ç°¡æ½”ãªèª¬æ˜", desc: "å¿™ã—ã„æ‚£è€…æ§˜ã«ã¯ã€è¦ç‚¹ã‚’çµã£ãŸãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªèª¬æ˜ãŒå–œã°ã‚Œã¾ã™ã€‚", snsTemplate: "ã€ãŠè–¬ã®ç–‘å•ã€å³è§£æ±ºğŸ’¡ã€‘\nã€Œã“ã‚Œã£ã¦é£²ã¿åˆã‚ã›å¤§ä¸ˆå¤«ï¼Ÿã€\nãã®ä¸å®‰ã€è–¬å‰¤å¸«ãŒã™ãã«ç¢ºèªã—ã¾ã™ã€‚\nã‚¹ãƒ”ãƒ¼ãƒ‰ã¨æ­£ç¢ºã•ã§çš†æ§˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\n#è–¬å‰¤å¸« #ãƒ—ãƒ­ã®ä»•äº‹" },
                        { title: "å¾…ã¡æ™‚é–“ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹", desc: "ã€Œã‚ã¨ã€‡åˆ†ãã‚‰ã„ã§ã™ã€ã¨å…·ä½“çš„ã«ä¼ãˆã‚‹ã ã‘ã§ã‚¹ãƒˆãƒ¬ã‚¹ãŒæ¿€æ¸›ã—ã¾ã™ã€‚", snsTemplate: "ã€å¾…ã¡æ™‚é–“ã‚’æœ‰åŠ¹ã«ğŸ“±ã€‘\nãŠè–¬ã®æº–å‚™ãŒã§ãã‚‹ã¾ã§ã€å¤–å‡ºã‚‚å¯èƒ½ã§ã™ã€‚\næº–å‚™å®Œäº†ã‚’LINEã§ãŠçŸ¥ã‚‰ã›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚‚å®Ÿæ–½ä¸­ï¼\n#å‡¦æ–¹ç®‹é€ä¿¡ #åŠ¹ç‡åŒ–" }
                    ],
                    info: [
                        { title: "Googleãƒãƒƒãƒ—æ•´å‚™", desc: "æ¤œç´¢ã—ã¦æ¥ã‚‹æ–¹ãŒå¤šã„ã§ã™ã€‚å–¶æ¥­æ™‚é–“ã‚„é§è»Šå ´ã®æƒ…å ±ã‚’æ­£ç¢ºã«ã€‚", snsTemplate: "ã€é§è»Šå ´ã®ã”æ¡ˆå†…ğŸš—ã€‘\nå½“è–¬å±€ã®è£æ‰‹ã«3å°åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ãŒã”ã–ã„ã¾ã™ã€‚\nãŠè»Šã§ã®ã”æ¥å±€ã‚‚ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚\n#é§è»Šå ´ã‚ã‚Š #ã‚¢ã‚¯ã‚»ã‚¹" }
                    ]
                },
                // åœ¨å®…ãƒ»æ–½è¨­ï¼ˆhomeï¼‰
                home: {
                    env: [
                        { title: "ä»‹è­·ç”¨å“ã®å±•ç¤º", desc: "ãŠã‚€ã¤ã‚„å£è…”ã‚±ã‚¢ç”¨å“ã‚’è¦‹ã‚„ã™ãé…ç½®ã—ã€ç›¸è«‡ã®ãã£ã‹ã‘ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚", snsTemplate: "ã€ä»‹è­·ã®æ‚©ã¿ã€ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿã€‘\nå£è…”ã‚±ã‚¢ã‚¹ãƒãƒ³ã‚¸ãªã©ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’å±•ç¤ºä¸­ã§ã™ã€‚\nå®Ÿéš›ã«è§¦ã£ã¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã­ã€‚\n#åœ¨å®…ä»‹è­· #å£è…”ã‚±ã‚¢" }
                    ],
                    hosp: [
                        { title: "å®¶æ—ã¸ã®åŠ´ã„", desc: "æ‚£è€…æ§˜æœ¬äººã ã‘ã§ãªãã€ä»‹è­·ã•ã‚Œã¦ã„ã‚‹ã”å®¶æ—ã¸ã®ã‚±ã‚¢ã‚‚å¿˜ã‚Œãšã«ã€‚", snsTemplate: "ã€ä»‹è­·ã‚’ã™ã‚‹çš†æ§˜ã¸ğŸµã€‘\næ¯æ—¥ãŠç–²ã‚Œæ§˜ã§ã™ã€‚\nãŸã¾ã«ã¯ã”è‡ªèº«ã®ä½“èª¿ã‚‚æ°—é£ã£ã¦ãã ã•ã„ã­ã€‚\nç§ãŸã¡ã‚‚ç²¾ä¸€æ¯ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\n#å®¶æ—ä»‹è­· #ãƒ¬ã‚¹ãƒ‘ã‚¤ãƒˆ" },
                        { title: "ä»–è·ç¨®é€£æºã‚¢ãƒ”ãƒ¼ãƒ«", desc: "åŒ»å¸«ã‚„ã‚±ã‚¢ãƒãƒã¨é€£æºã—ã¦ã„ã‚‹å®‰å¿ƒæ„Ÿã‚’ä¼ãˆã¾ã—ã‚‡ã†ã€‚", snsTemplate: "ã€ãƒãƒ¼ãƒ åŒ»ç™‚ã§æ”¯ãˆã¾ã™ğŸ¤ã€‘\nä»Šæ—¥ã¯åœ°åŸŸã®ã‚±ã‚¢ä¼šè­°ã«å‚åŠ ã—ã¦ãã¾ã—ãŸã€‚\nåŒ»å¸«ã‚„ã‚±ã‚¢ãƒãƒã•ã‚“ã¨é€£æºã—ã€ã‚ˆã‚Šè‰¯ã„åœ¨å®…åŒ»ç™‚ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚\n#åœ°åŸŸé€£æº #åœ¨å®…åŒ»ç™‚" }
                    ],
                    info: [
                        { title: "è¨ªå•ã‚µãƒ¼ãƒ“ã‚¹ã®æ¡ˆå†…", desc: "ã€Œè–¬ã‚’å±Šã‘ã¦ãã‚Œã‚‹ã€ã“ã¨ã‚’çŸ¥ã‚‰ãªã„æ–¹ã‚‚ã„ã¾ã™ã€‚ã‚ã‹ã‚Šã‚„ã™ãç™ºä¿¡ã‚’ã€‚", snsTemplate: "ã€ãŠè–¬ã€ãŠå±Šã‘ã—ã¾ã™ğŸššã€‘\né€šé™¢ãŒå¤§å¤‰ã«ãªã£ã¦ããŸâ€¦ãã‚“ãªæ™‚ã¯ã”ç›¸è«‡ãã ã•ã„ã€‚\nè–¬å‰¤å¸«ãŒã”è‡ªå®…ã¾ã§ãŠè–¬ã‚’ãŠå±Šã‘ã—ã€ç®¡ç†ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚\n#è¨ªå•è–¬å‰¤å¸« #åœ¨å®…" }
                    ]
                }
            },

            init() {
                this.loadHistory();
                this.updateMiniHistory();
                this.shuffleQuestions();
            },

            toggleHelp(show) {
                const modal = document.getElementById('helpModal');
                if(show) modal.classList.add('show');
                else modal.classList.remove('show');
            },
            
            toggleResetModal(show) {
                const modal = document.getElementById('resetModal');
                if(show) modal.classList.add('show');
                else modal.classList.remove('show');
            },

            // New: Toggle History Modal
            toggleHistoryModal(show) {
                const modal = document.getElementById('historyClearModal');
                if(show) modal.classList.add('show');
                else modal.classList.remove('show');
            },

            changeType(type) {
                this.currentType = type;
            },

            shuffleQuestions() {
                const pick = (arr, n) => {
                    const shuffled = [...arr].sort(() => 0.5 - Math.random());
                    return shuffled.slice(0, n);
                };
                this.activeQuestions.env = pick(questionPool.env, 3);
                this.activeQuestions.hosp = pick(questionPool.hosp, 3);
                this.activeQuestions.info = pick(questionPool.info, 3);
                this.renderQuestions();
            },

            renderQuestions() {
                const container = document.getElementById('questionsContainer');
                container.innerHTML = '';
                const categories = [
                    { id: 'env', title: '1. é›°å›²æ°—ãƒ»ç’°å¢ƒ', color: 'pink' },
                    { id: 'hosp', title: '2. æ¥å®¢ãƒ»ãƒ›ã‚¹ãƒ”ã‚¿ãƒªãƒ†ã‚£', color: 'green' },
                    { id: 'info', title: '3. æƒ…å ±ç™ºä¿¡ãƒ»åˆ©ä¾¿æ€§', color: 'blue' }
                ];

                categories.forEach(cat => {
                    const qs = this.activeQuestions[cat.id];
                    let html = `<div class="mb-6"><h3 class="font-bold text-gray-700 mb-3 border-l-4 border-${cat.color}-400 pl-3">${cat.title}</h3><div class="bg-white rounded-xl p-2">`;
                    qs.forEach(q => {
                        html += `<label class="check-item"><input type="checkbox" class="mr-3 w-5 h-5 accent-pink-500" data-cat="${cat.id}" value="1"><span>${q}</span></label>`;
                    });
                    html += `</div></div>`;
                    container.innerHTML += html;
                });
            },

            loadHistory() {
                const saved = localStorage.getItem('pharmacy_advisor_history');
                if (saved) { try { this.historyData = JSON.parse(saved); } catch(e) { this.historyData = []; } }
            },

            saveHistory(totalScore) {
                const today = new Date().toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                this.historyData.push({ date: today, score: totalScore });
                if (this.historyData.length > 10) this.historyData = this.historyData.slice(-10);
                localStorage.setItem('pharmacy_advisor_history', JSON.stringify(this.historyData));
            },

            // Modified: clearHistory now opens modal
            clearHistory() {
                this.toggleHistoryModal(true);
            },

            // New: Actually execute clear
            executeClearHistory() {
                this.toggleHistoryModal(false);
                localStorage.removeItem('pharmacy_advisor_history');
                this.historyData = [];
                this.updateMiniHistory();
                this.showToast('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            },

            updateMiniHistory() {
                const mini = document.getElementById('miniHistory');
                if (this.historyData.length > 0) {
                    const last = this.historyData[this.historyData.length - 1];
                    document.getElementById('lastDate').innerText = last.date;
                    document.getElementById('lastScore').innerText = last.score;
                    mini.classList.remove('hidden');
                } else {
                    mini.classList.add('hidden');
                }
            },

            analyze() {
                const envChecks = document.querySelectorAll('input[data-cat="env"]:checked').length;
                const hospChecks = document.querySelectorAll('input[data-cat="hosp"]:checked').length;
                const infoChecks = document.querySelectorAll('input[data-cat="info"]:checked').length;

                this.data = { env: envChecks, hosp: hospChecks, info: infoChecks };
                
                let total = (envChecks + hospChecks + infoChecks) * 11;
                if (total > 99) total = 100;
                if (total === 0 && (envChecks+hospChecks+infoChecks) > 0) total = 10;
                
                document.getElementById('totalScore').innerText = total;
                this.saveHistory(total);

                let weakness = 'env';
                let minVal = envChecks;
                if (hospChecks < minVal) { weakness = 'hosp'; minVal = hospChecks; }
                if (infoChecks < minVal) { weakness = 'info'; }

                const comments = {
                    high: "ç´ æ™´ã‚‰ã—ã„ï¼æ„›ã•ã‚Œè–¬å±€ã®åŸºæº–ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™ã€‚",
                    mid: "è‰¯ã„èª¿å­ã§ã™ã€‚ã‚ã¨ä¸€æ­©ã€ã€Œæ„Ÿå‹•ã€ã‚’ç”Ÿã‚€å·¥å¤«ã‚’ãƒ—ãƒ©ã‚¹ï¼",
                    low: "ä¼¸ã³ä»£ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãšã¯ä¸€ã¤ã€ç°¡å˜ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã€‚"
                };
                let comment = total > 80 ? comments.high : (total > 40 ? comments.mid : comments.low);
                document.getElementById('analysisComment').innerText = comment;

                this.renderChart(envChecks, hospChecks, infoChecks);
                this.renderHistoryChart();
                this.renderProposals(weakness);

                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                window.scrollTo(0,0);
            },

            renderProposals(weaknessCategory) {
                const list = document.getElementById('proposalList');
                list.innerHTML = '';
                const typeData = this.adviceDatabase[this.currentType] || this.adviceDatabase.local;
                const advices = typeData[weaknessCategory] || [];

                advices.forEach((adv, index) => {
                    const html = `
                        <div class="bg-white border border-gray-100 p-4 rounded-xl shadow-sm hover:shadow-md transition cursor-pointer" onclick="app.selectProposal('${weaknessCategory}', ${index})">
                            <div class="flex items-start">
                                <span class="bg-pink-100 text-pink-600 px-2 py-1 rounded text-xs font-bold mr-3 mt-1">æ¨å¥¨</span>
                                <div>
                                    <h4 class="font-bold text-gray-800 mb-1">${adv.title}</h4>
                                    <p class="text-sm text-gray-500 leading-relaxed">${adv.desc}</p>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-end">
                                <span class="text-xs text-blue-500 font-bold flex items-center">ã“ã‚Œã«å–ã‚Šçµ„ã‚€ â†’</span>
                            </div>
                        </div>`;
                    list.innerHTML += html;
                });
            },

            generateDrafts(baseText) {
                // 1. Standard (Original)
                const v1 = baseText;

                // 2. Friendly
                let v2 = baseText
                    .replace(/ã“ã‚“ã«ã¡ã¯ï¼/g, "ã“ã‚“ã«ã¡ã¯ï¼ğŸ˜Šâœ¨")
                    .replace(/ã¾ã—ãŸã€‚/g, "ã¾ã—ãŸï¼")
                    .replace(/ã§ã™ã€‚/g, "ã§ã™ğŸµ")
                    .replace(/ã€(.*?)ã€‘/g, "ã€ $1 âœ¨ã€‘");
                v2 += "\n\næ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚ãŠå£°ãŒã‘ãã ã•ã„ã­ğŸ’Š";

                // 3. Simple
                let v3 = baseText
                    .replace(/ã€.*?ã€‘\n/, "")
                    .replace(/ã“ã‚“ã«ã¡ã¯ï¼\n/, "")
                    .replace(/#.*/g, "");
                v3 = "ã€ãŠçŸ¥ã‚‰ã›ã€‘\n" + v3.trim() + "\n\n#è–¬å±€ #å¥åº·";

                return [v1, v2, v3];
            },

            selectProposal(category, index) {
                const typeData = this.adviceDatabase[this.currentType] || this.adviceDatabase.local;
                this.currentProposal = typeData[category][index];
                
                this.currentDraftVariations = this.generateDrafts(this.currentProposal.snsTemplate);
                this.setDraftVariation(0);

                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                window.scrollTo(0,0);
            },
            
            setDraftVariation(index) {
                const box = document.getElementById('snsDraftText');
                box.innerText = this.currentDraftVariations[index];
                
                document.querySelectorAll('.var-tab').forEach((tab, i) => {
                    if (i === index) tab.classList.add('active');
                    else tab.classList.remove('active');
                });
            },

            showSnsDraft() {
                if (!this.currentProposal) {
                    const defaultText = "ã€ã‚ˆã‚Šè‰¯ã„è–¬å±€ã‚’ç›®æŒ‡ã—ã¦âœ¨ã€‘\nã“ã‚“ã«ã¡ã¯ï¼\nå½“è–¬å±€ã§ã¯ã€æ‚£è€…æ§˜ã«ã‚ˆã‚Šå¿«é©ã«éã”ã—ã¦ã„ãŸã ã‘ã‚‹ã‚ˆã†ã€ã‚µãƒ¼ãƒ“ã‚¹ã®è¦‹ç›´ã—ã‚’è¡Œã„ã¾ã—ãŸã€‚\nãŠæ°—ã¥ãã®ç‚¹ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠå£°ãŒã‘ãã ã•ã„ã€‚\n#åœ°åŸŸå¯†ç€ #è–¬å±€ #å¥åº·ã‚µãƒãƒ¼ãƒˆ";
                    this.currentDraftVariations = this.generateDrafts(defaultText);
                } else {
                    this.currentDraftVariations = this.generateDrafts(this.currentProposal.snsTemplate);
                }
                
                this.setDraftVariation(0);
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                window.scrollTo(0,0);
            },

            backToResult() {
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
            },

            reset(confirmRequired) {
                if(confirmRequired) {
                    this.toggleResetModal(true);
                } else {
                    this.executeReset();
                }
            },
            
            executeReset() {
                this.toggleResetModal(false);
                
                // Reset data
                this.data = { env: 0, hosp: 0, info: 0 };
                this.currentProposal = null;
                document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
                
                // Reset UI
                this.updateMiniHistory();
                this.shuffleQuestions();
                
                // Handle view switching
                const step1 = document.getElementById('step1');
                step1.classList.remove('hidden');
                step1.classList.remove('animate-slide-up');
                void step1.offsetWidth; // Force reflow
                step1.classList.add('animate-slide-up');

                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.add('hidden');
                
                window.scrollTo(0, 0);
            },

            copyText() {
                const text = document.getElementById('snsDraftText').innerText;
                navigator.clipboard.writeText(text).then(
                    () => this.showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'), 
                    () => this.showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ')
                );
            },

            copyReport() {
                const score = document.getElementById('totalScore').innerText;
                const comment = document.getElementById('analysisComment').innerText;
                const today = new Date().toLocaleDateString('ja-JP');
                let report = `ã€æ„›ã•ã‚Œè–¬å±€è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã€‘\nå®Ÿæ–½æ—¥: ${today}\nã‚¿ã‚¤ãƒ—: ${this.getTypeLabel()}\nã‚¹ã‚³ã‚¢: ${score}ç‚¹\nè©•ä¾¡: ${comment}\n[å†…è¨³]\n- ç’°å¢ƒ: ${this.data.env}/3\n- æ¥å®¢: ${this.data.hosp}/3\n- æƒ…å ±: ${this.data.info}/3\n`;
                navigator.clipboard.writeText(report).then(
                    () => this.showToast('è¨ºæ–­çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'), 
                    () => this.showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ')
                );
            },
            
            showToast(msg) {
                const el = document.getElementById('toast');
                el.innerText = msg;
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 2000);
            },
            
            getTypeLabel() {
                if(this.currentType === 'local') return 'åœ°åŸŸå¯†ç€';
                if(this.currentType === 'busy') return 'é–€å‰ãƒ»ç·åˆ';
                if(this.currentType === 'home') return 'åœ¨å®…ãƒ¡ã‚¤ãƒ³';
                return '';
            },

            renderChart(env, hosp, info) {
                const ctx = document.getElementById('radarChart').getContext('2d');
                if (this.chart) this.chart.destroy();
                this.chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['é›°å›²æ°—ãƒ»ç’°å¢ƒ', 'æ¥å®¢ãƒ»å¯¾è©±', 'æƒ…å ±ãƒ»åˆ©ä¾¿æ€§'],
                        datasets: [{
                            label: 'ä»Šå›ã®ã‚¹ã‚³ã‚¢',
                            data: [env, hosp, info],
                            backgroundColor: 'rgba(255, 139, 167, 0.4)',
                            borderColor: '#FF8BA7',
                            pointBackgroundColor: '#E05D82',
                            borderWidth: 2
                        }]
                    },
                    options: { maintainAspectRatio: false, scales: { r: { angleLines: {display:true}, suggestedMin:0, suggestedMax:3, ticks:{stepSize:1, display:false} } }, plugins: { legend: {display:false} } }
                });
            },

            renderHistoryChart() {
                const ctx = document.getElementById('historyChart').getContext('2d');
                if (this.historyChart) this.historyChart.destroy();
                const displayData = this.historyData.slice(-5);
                this.historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: displayData.map(d => d.date),
                        datasets: [{ label: 'ã‚¹ã‚³ã‚¢', data: displayData.map(d => d.score), borderColor: '#6BCB77', backgroundColor: 'rgba(107, 203, 119, 0.2)', tension: 0.3, fill: true }]
                    },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero:true, max:100 } }, plugins: { legend: {display:false} } }
                });
            }
        };

        window.onload = function() {
            app.init();
        };
    </script>
</body>
</html>